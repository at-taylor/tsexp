<!DOCTYPE html>
<html>
<head>
    <title></title>
</head>
<body>

<div id="mediaEditPage" data-role="page" data-add-back-btn="true" data-back-btn-text="back" data-back-btn-theme="c">

    <div data-theme="c" data-role="header" data-position="fixed" >
        <h1><img src="img/splash/logo.png"></h1>
        <a href="#MainNavPage" data-icon="home" class="ui-btn-right">Home</a>

    </div>

    <div data-role="content">
        <div >
            <h1>Edit Media</h1>
        </div>


    <div class="ui-grid-a">
        <div class="ui-block-a" style="width:55%; padding-left: 5%; padding-right: 2%">
            <div data-role="fieldcontainer">
                <label for="editTitleTxt">Title:</label><input type="text" id="editTitleTxt"  length=80 placeholder="Enter a Title for this Media">
            </div>
            <div data-role="fieldcontainer">
                <label for="editDateTxt">Date Taken:</label><input type="number"  id="editDateTxt" >
            </div>
            <div data-role="fieldcontainer">
                <label for="editDescrTxt">Description:</label><textarea rows="4" cols="50" id="editDescrTxt" length=200 placeholder="Enter a descrition for this media"></textarea>
            </div>
            <div data-role="fieldcontainer">
                <div id="editCategoryDiv">
                    <label for="editCategoryList">Categories</label>
                    <select id="editCategoryList"  multiple >
                        <!--<option value="1">red</option>-->
                        <!--<option value="2">green</option>-->
                        <!--<option value="3">yellow</option>-->
                        <!--<option value="4">blue</option>-->
                    </select>
                </div> <!-- categoryDiv -->
            </div>
        </div>
        <div class="ui-block-b" style="text-align: center; width:45%; padding-left: 2%; padding-right: 5%">
            <div data-role="fieldcontainer">
            <img id="editImage" heigth=360 width=270 >
                </div>
            <!--<label for="fileInfoTxt">File Info:</label><input type="text" id="fileInfoTxt" name="fileInfoTxt" >-->
            <!--<label for="fileLocTxt">File Loc:</label><input type="text" id="fileLocTxt" name="fileLocTxt" >-->
            <!--<button id="uploadBtn" name="uploadBtn">Upload My Media</button>-->
            <div data-role="fieldcontainer">
            <a href="#editConfirm" data-role="button" data-rel="popup">Edit My Media</a>
            </div>
            <label for="fileUploadTxt">Error Info:</label><input type="text" id="fileUploadTxt" name="fileUploadTxt" >
        </div>

    </div>


    <div data-role="popup" id="editConfirm">
        <h2>This will change the media data</h2>
        <a href="#" data-rel="back" data-role="button" data-theme="a" >Don't Allow</a>
        <button type="submit" id="editBtn" name="editBtn"> Yes! Edit My Media</button>
    </div>

    <div data-theme="c" data-role="footer" data-position="fixed" class="ui-bar" style="text-align: center" >
        <div style="display: inline-block"></div>
        <a href="#MainNavPage"><img height="51" width="50" src="img/navbut/home.png" /></a>
        <a href="#"><img height="51" width="50" src="img/navbut/user.png" /></a>
        <a href="media-capture.html"><img height="51" width="50" src="img/navbut/addMedia.png" /></a>
        <a href="#"><img height="51" width="50" src="img/navbut/inviteFriends.png" /></a>
        <a href="#"><img height="51" width="50" src="img/navbut/myAccount.png" /></a>
        <a href="#"><img height="51" width="50" src="img/navbut/tellStory.png" /></a>
        <a href="media-library.html"><img height="51" width="50" src="img/navbut/mediaLIbrary.png" /></a>
        <a href="story-directory.html"><img height="51" width="50" src="img/navbut/storyLibrary.png" /></a>
        <a href="#"><img height="51" width="50" src="img/navbut/requestStory.png" /></a>
    </div>


</div>

    <script>

        var serviceURL = tsServiceURLDomain + "tssvc/resourcesS/media";
        var serviceCategoryURL = tsServiceURLDomain + "tssvc/resourcesS/categories";

        console.log("media-edit.js: Executing");
        console.log("mediaEditPage: executing using services at: " + serviceURL);
        console.log("mediaEditPage: executing using category services at: " + serviceCategoryURL);

        $('#mediaEditPage').bind('pageinit', function(event) {
            console.log('mediaEditPage: bind: pageinit()');
        })

        $(document).on('pagebeforeshow', '#mediaEditPage', function(){

            console.log('mediaEditPage: pagebeforeshow()');
            var mediaId = getUrlVars() ["id"];
            console.log ("mediaEditPage: pagebeforeshow(): called with media id=" + mediaId);

            //console.log("activePage: " + $.mobile.activePage.data('url')   );
            //console.log("urlHistory: " + $.mobile.urlHistory.getActive().url)   ;

            var categoryResultArray = new Array();
            $.getJSON(serviceURL + '/' + mediaId, function(data) {

                console.log("mediaEditPage: Title : " + data.title);
                console.log("mediaEditPage: Created : " + data.mediaDateRaw);
                console.log("mediaEditPage: Descr : " + data.descr);

                // Build array of selected categories, use to set the 'selected' values
                var iItr = 0;
                for(var i in data.categoryList)    {
                    //console.log("index: " + iItr);
                    //console.log("value: " + i)  ;
                    categoryResultArray.push([i])  ;
                    iItr = Number(iItr) + 1;
                }
                $('#editTitleTxt').val(data.title);
                $('#editDateTxt').val(data.mediaDateRaw);
                $('#editDescrTxt').val(data.descr);
                $('#editImage').attr("src", data.url);

                console.log("mediaEditPage: starting category load.");
                $.getJSON(serviceCategoryURL, function(data) {

                    $('#editCategoryList option').remove();       // clear previous entries

                    cat = data.categoryModelList;
                    $.each(cat, function(index, item) {
                        var optionListItem = "<option value='" + item.categoryId + "'>" +item.categoryDescr + "</option>";
                        $('#editCategoryList').append(optionListItem);
                    });

                    // make selected any items that are in the result array
                    //console.log("Category Array outer processing.  Length: " + categoryResultArray.length) ;
                    for(i = 0; i < categoryResultArray.length; i++) {
                        //console.log("value at index: " + i + " is " + categoryResultArray[i] )
                        $("#editCategoryList option[value='"+categoryResultArray[i]+"']").attr('selected', 'selected');
                    }
                    $('#editCategoryList').selectmenu("refresh", true);
                });
                console.log("mediaEditPage: ending category load.");

            });

            $('#editBtn').click(function(event) {
                console.log("mediaAddPageAdd: editBtn.click(): for id of: " + mediaId);

                $('[type="submit"]').button('disable');

                var selectedValsArray = $('#editCategoryList').val();
                console.log("mediaAddPageAdd: editBtn.click(): selected Category Array" + selectedValsArray);
                var jsonStringArr = JSON.stringify(selectedValsArray);
                console.log("mediaAddPageAdd: editBtn.click():  selected Category Array as JSON" + jsonStringArr);

                updateMediaItem(mediaId, $('#editTitleTxt').val(), $('#editDateTxt').val(),$('#editDescrTxt').val(), jsonStringArr, 'media-library-grid.html', document.getElementById('fileUploadTxt'));

            });

        });    // end of pagebeforeshow

        function getUrlVars() {

            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');

            for(var i = 0; i < hashes.length; i++)
            {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }

    </script>

    </div>


</body>
</html>