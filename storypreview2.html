<html>

<head>
</head>

<body>

<div id="storyNewPreviewPage" data-role="page" data-add-back-btn="false" data-back-btn-text="back" data-back-btn-theme="c" style="background: #efeade;">


<div data-theme="b" data-role="header" data-position="fixed" class="TsHeader" >
    <h1>Treasured Stories</h1>
    <a data-theme="b" id="storyPreviewNewBackBtn" href="#" data-role="button" data-mini="true" data-icon="back" class="ui-btn-left">Back</a>
</div>


<div data-role="content">

    <div>
        <a id="storyNewPublishPopLink" href="#storyNewPublishConfirm" class="ui-btn-right" data-theme="d" data-mini= "true"  data-role="button" data-rel="popup">Publish This Story</a>
        <a id="storyNewCancelPopLink" href="#storyNewCancelConfirm" class="ui-btn-right" data-theme="d" data-mini= "true" data-role="button" data-rel="popup">Cancel It Completely</a>
        <button id="storyPreviewNewEditBtn" data-role="button" class="ui-btn-right" data-mini= "true" data-theme="d">Continue to Edit</button>
        <!--<div style="text-align: right; float:right; padding-right: 2%;">-->
            <!--<a id="storyEditNewNextBtn" href="#" data-role="none" data-shadow="false" data-theme="none">-->
                <!--<img src="img/navbut/next1.png" border="0"/>-->
            <!--</a>-->
        <!--</div>-->
    </div>
    <!--<p style="clear:both;"></p>-->
    <!--<h2 >Publish Story</h2>-->


    <section class="ui-grid-a">
        <div class="ui-block-a" style="width=60%">
            <div id="preview">
                <hr>
                <h1><div id="storyPreviewTitleTxt"></div></h1>
                <h2><div id="storyPreviewDateTxt" ></div></h2>
                <div id="previewCategoryDiv">
                   <a id="categoryBtn" class="categoryBtn" data-theme="none" data-role="none">
                        <!--<i class="fa fa-tag fa-4x" style="color:white;" data-theme="none" data-role="none"></i>Love-->
                        <!--<i class="fa fa-tag fa-4x" style="color:white;" data-theme="none" data-role="none"></i>Family-->
                        <!--<i class="fa fa-tag fa-4x" style="color:white;" data-theme="none" data-role="none"></i>Work-->
                    </a>
                </div>
                <div class="storyPreviewFlipSwitchContainer" style=".ui-slider-switch { width: 9em };">
                    <select id="storyPreviewNewPrivacySwitch" disabled data-role="slider">
                        <option value="0">Public</option>
                        <option value="1">Private</option>
                    </select>
                </div>
                <hr>
                <div id="storyPreviewContent" ></div>
            </div>  <!-- preview -->
        </div>
        <div class="ui-block-b" style="width:40%;padding-left:2%;">
            <div id="previewBtn">
                <!--<a id="storyNewPublishPopLink" href="#storyNewPublishConfirm" data-theme="d" data-mini= "true"  data-role="button" data-rel="popup">Publish This Story</a>-->
                <!--<a id="storyNewCancelPopLink" href="#storyNewCancelConfirm" data-theme="d" data-mini= "true" data-role="button" data-rel="popup">Cancel It Completely</a>-->
                <!--<button id="storyPreviewNewEditBtn" data-role="button" data-mini= "true" data-theme="d">Continue to Edit</button>-->

                <!--<button data-role="button" data-mini= "true" data-theme="b">Publish This Story</button>-->
                <!--<button data-role="button" data-mini= "true" data-theme="b">Save as Draft</button>-->

                <!--<button data-role="button" data-mini= "true" data-theme="b">Cancel It Completely</button>-->
            </div>    <!-- previewBtn div end -->
            <div data-role="controlgroup" id="controlgroupPreview" data-type="horizontal">
                <!--<input type="checkbox"  data-inline="true" id="testCheck" class="mediaCheck" value=1>-->
                <!--<label for="testCheck"><img src= "http://app.treasuredstories.com/uploaded/media/image/p1809d3l0osiucqmv73513pr5.png" width=100></label>-->
            </div>     <!-- controlgroup div end -->

        </div>

    </section>

    <div data-role="popup" id="storyNewPublishConfirm">
        <h2>Would you like to upload this story to your Treasured Stories account?</h2>
        <a href="#" data-rel="back" data-role="button" data-theme="a" >Not yet, just close this dialog for now</a>
        <button type="submit" id="storyNewPublishUploadBtn" > Yes, please upload this story to my account</button>
    </div>   <!-- end of storyNewPublishConfirm -->

    <div data-role="popup" id="storyNewCancelConfirm">
        <h2>Would you like to cancel this story? If you confirm, no information for this story will be saved or uploaded to your Treasured Stories account. </h2>
        <button type="submit" id="storyNewCancelBtn" >Yes, Cancel and do not save or upload anything</button>
        <a href="#" data-rel="back" data-role="button" data-theme="a" >Not sure, just close this dialog for now</a>

    </div>   <!-- end of storyNewCancelConfirm-->

</div>       <!-- end of content div -->

<!--<div data-theme="c" data-role="footer"  class="ui-bar" style="text-align: center" >-->
    <!--<div style="display: inline-block"></div>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/home.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/user.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/addMedia.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/inviteFriends.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/myAccount.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/tellStory.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/mediaLIbrary.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/storyLibrary.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/requestStory.png" /></a>-->
<!--</div>-->


<link type="text/css" rel="stylesheet" href="demo.css">


<script type="text/javascript">

    console.log("storyNewPreviewPage: init");


    $(document).on('pagebeforeshow', '#storyNewPreviewPage', function()
    {
        console.log("storyNewPreviewPage: pagebeforeshow()");

        console.log("storyNewPreviewPage: pagebeforeshow(); Called with Title: " + sessionStorage.getItem("storyTitle"));
        console.log("storyNewPreviewPage: pagebeforeshow(); Called with Date: " + sessionStorage.getItem("storyDate"));
        console.log("storyNewPreviewPage: pagebeforeshow(); Called with Content: " + sessionStorage.getItem("storyContent"));
        console.log("storyNewPreviewPage: pagebeforeshow(); Called with Categories: " + sessionStorage.getItem("storyCategories"));

        // 1. Reset buttons to initialized state
        $('#storyNewPublishUploadBtn').button('enable');
        $('#storyNewCancelBtn').button('enable');
        $('#storyNewPublishPopLink').removeClass('ui-disabled');
        $('#storyNewCancelPopLink').removeClass('ui-disabled');
        $('#storyPreviewNewBackBtn').removeClass('ui-disabled');
        $('#storyPreviewNewEditBtn').removeClass('ui-disabled');

        $('#storyPreviewTitleTxt').html("");
        $('#storyPreviewTitleTxt').append(sessionStorage.getItem("storyTitle"));

        $('#storyPreviewNewPrivacySwitch').val(sessionStorage.getItem("storyPrivacy")).slider("refresh");

        $('#storyPreviewDateTxt').html("");
        var storyDate = sessionStorage.getItem("storyDate");
        var storyDateLen = storyDate.length;

        if (storyDateLen == 10) {
            //var dateFormatted = new Date(storyDate.substring(0,3), storyDate.substring(5,6), storyDate.substring(8,9));
//            console.log("mm: " + storyDate.substring(5,7));
//            console.log("yy: " + storyDate.substring(0,4));
//            console.log("dd: " +  storyDate.substring(8,10));
            var dateFormatted = printMonth(storyDate.substring(5,7)) + ' ' + storyDate.substring(8,10) + ', ' + storyDate.substring(0,4);
            $('#storyPreviewDateTxt').append(dateFormatted);
        }

        $('#storyPreviewContent').html("");
        $('#storyPreviewContent').append(sessionStorage.getItem("storyContent"));

        var categoryResultArray = JSON.parse(sessionStorage.getItem("storyCategories"));
        $('.fa').remove();
        $('.txtfa').remove();
        if (categoryResultArray == null)  {
            console.log ("storyPreviewPage: pagebeforeshow(): No Categories to Display: removing categoryBtn");
           $('.categoryBtn').remove();
        }
        else {
            console.log ("storyPreviewPage: pagebeforeshow(): Categories found to Display.  Number: " +  categoryResultArray.length);

            if (document.getElementById('categoryBtn') == null ) {
                console.log("storyPreviewPage: pagebeforeshow(): Re-adding categoryBtn to DOM");
                $('#previewCategoryDiv').append('<a id="categoryBtn" class="categoryBtn" data-theme="none" data-role="none">');
            }
            for(i = 0; i < categoryResultArray.length; i++) {
                //console.log("value at index: " + i + " is " + categoryResultArray[i] )

                var catDescr = sessionStorage.getItem("appCacheCat" + categoryResultArray[i]);
                var catItem = '<i class="fa fa-tag fa-3x" style="color:white;padding:5px;" data-theme="none" data-role="none"></li><div class="txtfa"> ' + catDescr + '</div>' ;

                console.log("storyPreviewPage: pagebeforeshow(): Category Add: " + catItem);
                $('.categoryBtn').append(catItem);

            }
            $('#previewCategoryDiv').trigger('create');
        }

        console.log ("storyPreviewPage: pagebeforeshow(): Start Media Processing for: " + sessionStorage.getItem("storyMediaItems"));

        var mediaResultArray = JSON.parse(sessionStorage.getItem("storyMediaItems"));

        console.log("storyPreviewPage: pagebeforeshow(): removing only checkboxes for the preview page");
        $('#controlgroupPreview .ui-checkbox').remove();
        if (mediaResultArray != null)
        {
            var group = $( "#controlgroupPreview" );
            //console.log("before inner for statement")

            for(i = 0; i < mediaResultArray.length; i++) {
                var $el;
                var theUrl = sessionStorage.getItem("storyAddMediaId" + mediaResultArray[i]) ;
                //console.log("before if check on url");
                //console.log(theUrl);
                if (theUrl != null) {
                   // console.log("in url not null");
                    $el = $('<input type="checkbox"  data-inline="true" id="mediaCheck' + mediaResultArray[i] + '" class="mediaCheck" value=' + mediaResultArray[i]  +' ><label for="mediaCheck' + mediaResultArray[i]  +'"><img width=200 height=200 src= "' + theUrl+ '"></label>');
                    //console.log("Element :" + $el);
                    $( "#controlgroupPreview" ).controlgroup( "container" )["append"]( $el );
                }
            }
            group.controlgroup( "refresh" );
            $('#controlgroupPreview').trigger('create');

        }
        console.log ("storyPreviewPage: pagebeforeshow(): End Media Processing"   );

        // 4. Set any button event handlers remembering to unset them first
        $(document).off('click', '#storyNewPublishUploadBtn').on('click', '#storyNewPublishUploadBtn',function(event) {

            console.log("storyPreviewPage: storyNewPublishUploadBtn.click()");

            $('#storyNewPublishUploadBtn').button('disable');
            $('#storyNewCancelBtn').button('disable');
            $('#storyNewPublishPopLink').addClass('ui-disabled');
            $('#storyNewCancelPopLink').addClass('ui-disabled');

            var catArr = new Array();
            catArr = JSON.parse(sessionStorage.getItem("storyCategories"));
            var mediaArr = new Array();
            mediaArr = JSON.parse(sessionStorage.getItem("storyMediaItems"));

            var storyContentClean = sessionStorage.getItem("storyContent");

            //str.replace(/blue/g,"red");
            storyContentClean = storyContentClean.replace(/&nbsp;/g, " ");
            //storyContentClean = encodeURI(storyContentClean);
            console.log("cleaning content: replace g " + storyContentClean);

            var storyAddJson = {
                title: sessionStorage.getItem("storyTitle"),
                descr: null,
                excerpt: null,
                categoryList:  catArr,
                mediaList: mediaArr,
                recordingUrl: null,
                archived: Number(0),
                age: null,
                storyMM: null,
                storyDD: null,
                storyYY: null,
                privacySetting: Number(sessionStorage.getItem("storyPrivacy")),
                publishStatus: Number(0),
                content:storyContentClean
            }
            var storyDate = sessionStorage.getItem("storyDate");
            if (storyDate.length = 10)  {
                storyAddJson.storyMM = storyDate.substring(5,7);
                storyAddJson.storyYY = storyDate.substring(0,4);
                storyAddJson.storyDD = storyDate.substring(8,10);
            }

            console.log("storyPreviewNewPage: publish: json=" + JSON.stringify(storyAddJson));

            $.ajax({
                //type: "POST",
                type: "GET",
                url: tsServiceURLDomain + "tssvc/resourcesS/stories/add/?storyAddJson=" + JSON.stringify(storyAddJson),
                //url: tsServiceURLDomain + "tssvc/resourcesS/stories/add/",
                //data:'user='+ $('#user').val() +'&pass='+ $('#pass').val(),
                //data: "storyAddJson=" + storyAddJson,
                cache: false,
                success: function(data) {
                    //validate the response here, set variables... whatever needed
                    //and if credentials are valid, forward to the next page
                    //alert ("logon valid");
                    console.log("storyPreviewNewPage: addStory: success data: " + data);
                    //console.log("loginPage: login: success: webSession: " + data.webSessionId);
                    //console.log("loginPage: login: success: msg: " + data.msg);

                    //if (data.isAuth = "true")  {
                        //alert("data is" + data.isAuth) ;
                    removeNewStoryStorage();
                    $('#controlgroup .ui-checkbox').remove(); // get rid of media checkbox items (storyEditNewPage)

                    $.mobile.changePage('tsnav.html');
                    //}
                    //else
                      //  alert("Please try to login again");
                },
                error: function() { // server couldn't be reached or other error
                    alert("Story add failed");
                }
            })

//            var fileUrl = sessionStorage.getItem("fileUrl");
//            var mediaId;
//            if (Number(fileUrl.indexOf("http")) > 0)  {
//                console.log("url contains http: " + fileUrl);
//                uploadFileFromUrl();
//                console.log("id returned: " + mediaId)
//            }
//            else   {
//                console.log("url does not contain http: " + fileUrl);
//                uploadFileFromFileHandle () ;
//            }
        });

        $(document).off('click', '#storyNewCancelBtn').on('click', '#storyNewCancelBtn',function(event) {

            console.log("storyPreviewPage: storyNewCancelBtn.click()");

            $('#storyNewCancelBtn').button('disable');
            $('#storyNewPublishUploadBtn').button('disable');
            $('#storyNewPublishPopLink').addClass('ui-disabled');
            $('#storyNewCancelPopLink').addClass('ui-disabled');

            removeNewStoryStorage();
            $('#controlgroup .ui-checkbox').remove(); // get rid of media checkbox items (storyEditNewPage)

            $.mobile.changePage('tsnav.html');

        });

        $(document).off('click', '#storyPreviewNewBackBtn').on('click', '#storyPreviewNewBackBtn',function(event) {

            console.log("storyPreviewPage: storyPreviewNewBackBtn.click()");

            $.mobile.changePage('storyeditnew.html');

        });

        $(document).off('click', '#storyPreviewNewEditBtn').on('click', '#storyPreviewNewEditBtn',function(event) {

            console.log("storyPreviewPage: storyPreviewNewEditBtn.click()");

            $.mobile.changePage('storyeditnew.html');

        });


        console.log("storyPreviewPage: pagebeforeshow(): end");

    });

    function printMonth(mm) {
        var month=new Array(12);

        month[0]="January";
        month[1]="February";
        month[2]="March";
        month[3]="April";
        month[4]="May";
        month[5]="June";
        month[6]="July";
        month[7]="August";
        month[8]="September";
        month[9]="October";
        month[10]="November";
        month[11]="December";

        return(month[Number(mm)-1]);
    }


</script>

</div> <!-- end of storyPreviewPage -->

</body>
</html>