<html>

<head>
</head>

<body>

<div id="storyNewPreviewPage" data-role="page" data-add-back-btn="false" data-back-btn-text="back" data-back-btn-theme="c" style="background: #efeade;">


<div data-theme="b" data-role="header" data-position="fixed" class="TsHeader" >
    <h1>Treasured Stories</h1>
    <a data-theme="b" id="storyPreviewNewBackBtn" href="#" data-role="button" data-mini="true" data-icon="back" class="ui-btn-left">Back</a>
</div>


<div data-role="content">

    <div>
        <a id="storyNewPublishPopLink" href="#storyNewPublishConfirm" class="ui-btn-right" data-theme="d" data-mini= "true"  data-role="button" data-rel="popup">Publish This Story</a>
        <a id="storyNewCancelPopLink" href="#storyNewCancelConfirm" class="ui-btn-right" data-theme="d" data-mini= "true" data-role="button" data-rel="popup">Cancel It Completely</a>
        <button id="storyPreviewNewEditBtn" data-role="button" class="ui-btn-right" data-mini= "true" data-theme="d">Continue to Edit</button>
        <!--<div style="text-align: right; float:right; padding-right: 2%;">-->
            <!--<a id="storyEditNewNextBtn" href="#" data-role="none" data-shadow="false" data-theme="none">-->
                <!--<img src="img/navbut/next1.png" border="0"/>-->
            <!--</a>-->
        <!--</div>-->
    </div>
    <!--<p style="clear:both;"></p>-->
    <!--<h2 >Publish Story</h2>-->


    <section class="ui-grid-a">
        <div class="ui-block-a" style="width=60%">
            <div id="preview">
                <hr>
                <div>
                    <div style="float: left; "><h2><div style="vertical-align: text-top;" id="storyPreviewTitleTxt"></div></h2></div>
                    <div style="float: right; vertical-align: bottom;">
                        <div class="storyPreviewFlipSwitchContainer" style=".ui-slider-switch { width: 9em };">
                            <select id="storyPreviewNewPrivacySwitch" disabled data-role="slider">
                                <option value="0">Public</option>
                                <option value="1">Private</option>
                            </select>
                        </div>
                    </div>
                </div>
                 <div style="clear:both"></div>


                <h3><div id="storyPreviewDateTxt" ></div></h3>
                <!--<div id="storyPreviewDateToggle" class="flipSwitchContainer" style=".ui-slider-switch { width: 12em };">-->
                    <!--<label for="storyPreviewNewDateSwitch">Exact or approximate date:</label>-->
                    <!--<select id="storyPreviewNewDateSwitch" disabled data-role="slider">-->
                        <!--<option value="0">Exact</option>-->
                        <!--<option value="1">Around</option>-->
                    <!--</select>-->
                <!--</div>-->

                <div id="previewCategoryDiv">
                   <a id="categoryBtn" class="categoryBtn" data-theme="none" data-role="none">
                        <!--<i class="fa fa-tag fa-4x" style="color:white;" data-theme="none" data-role="none"></i>Love-->
                        <!--<i class="fa fa-tag fa-4x" style="color:white;" data-theme="none" data-role="none"></i>Family-->
                        <!--<i class="fa fa-tag fa-4x" style="color:white;" data-theme="none" data-role="none"></i>Work-->
                    </a>
                </div>
                <div id="jquery_jplayer_preview" class="jp-jplayer"></div>
                <div id="jp_container_1" class="jp-audio">
                    <div class="jp-type-single">
                        <div class="jp-gui jp-interface">
                            <ul class="jp-controls">
                                <li><a href="javascript:;" class="jp-play" tabindex="1">play</a></li>
                                <li><a href="javascript:;" class="jp-pause" tabindex="1">pause</a></li>
                                <li><a href="javascript:;" class="jp-stop" tabindex="1">stop</a></li>
                                <li><a href="javascript:;" class="jp-mute" tabindex="1" title="mute">mute</a></li>
                                <li><a href="javascript:;" class="jp-unmute" tabindex="1" title="unmute">unmute</a></li>
                                <li><a href="javascript:;" class="jp-volume-max" tabindex="1" title="max volume">max volume</a></li>
                            </ul>
                            <div class="jp-progress">
                                <div class="jp-seek-bar">
                                    <div class="jp-play-bar"></div>
                                </div>
                            </div>
                            <div class="jp-volume-bar">
                                <div class="jp-volume-bar-value"></div>
                            </div>
                            <div class="jp-time-holder">
                                <div class="jp-current-time"></div>
                                <div class="jp-duration"></div>

                                <ul class="jp-toggles">
                                    <li><a href="javascript:;" class="jp-repeat" tabindex="1" title="repeat">repeat</a></li>
                                    <li><a href="javascript:;" class="jp-repeat-off" tabindex="1" title="repeat off">repeat off</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="jp-title" style="line-height:.75;">
                            <ul style="font: italic" id="storyPreviewNewAudioTitleList">
                                <li id="storyPreviewNewAudioTitleListItem"></li>
                            </ul>
                        </div>
                        <div class="jp-no-solution">
                            <span>Update Required</span>
                            To play the media you will need to either update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>.
                        </div>
                    </div>
                </div>
                <hr>
                <div id="storyPreviewContent" ></div>
            </div>  <!-- preview -->
        </div>
        <div class="ui-block-b" style="width:40%;padding-left:2%;">
            <div id="previewBtn">
                <!--<a id="storyNewPublishPopLink" href="#storyNewPublishConfirm" data-theme="d" data-mini= "true"  data-role="button" data-rel="popup">Publish This Story</a>-->
                <!--<a id="storyNewCancelPopLink" href="#storyNewCancelConfirm" data-theme="d" data-mini= "true" data-role="button" data-rel="popup">Cancel It Completely</a>-->
                <!--<button id="storyPreviewNewEditBtn" data-role="button" data-mini= "true" data-theme="d">Continue to Edit</button>-->

                <!--<button data-role="button" data-mini= "true" data-theme="b">Publish This Story</button>-->
                <!--<button data-role="button" data-mini= "true" data-theme="b">Save as Draft</button>-->

                <!--<button data-role="button" data-mini= "true" data-theme="b">Cancel It Completely</button>-->
            </div>    <!-- previewBtn div end -->
            <div data-role="controlgroup" id="controlgroupPreview" data-type="horizontal">
                <!--<input type="checkbox"  data-inline="true" id="testCheck" class="mediaCheck" value=1>-->
                <!--<label for="testCheck"><img src= "http://app.treasuredstories.com/uploaded/media/image/p1809d3l0osiucqmv73513pr5.png" width=100></label>-->
            </div>     <!-- controlgroup div end -->

        </div>

    </section>

    <div data-role="popup" id="storyNewPublishConfirm">
        <h2>Would you like to upload this story to your Treasured Stories account?</h2>
        <a href="#" data-rel="back" data-role="button" data-theme="a" >Not yet, just close this dialog for now</a>
        <button type="submit" id="storyNewPublishUploadBtn" > Yes, please upload this story to my account</button>
    </div>   <!-- end of storyNewPublishConfirm -->

    <div data-role="popup" id="storyNewCancelConfirm">
        <h2>Would you like to cancel this story? If you confirm, no information for this story will be saved or uploaded to your Treasured Stories account. </h2>
        <button type="submit" id="storyNewCancelBtn" >Yes, Cancel and do not save or upload anything</button>
        <a href="#" data-rel="back" data-role="button" data-theme="a" >Not sure, just close this dialog for now</a>

    </div>   <!-- end of storyNewCancelConfirm-->

</div>       <!-- end of content div -->

<!--<div data-theme="c" data-role="footer"  class="ui-bar" style="text-align: center" >-->
    <!--<div style="display: inline-block"></div>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/home.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/user.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/addMedia.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/inviteFriends.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/myAccount.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/tellStory.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/mediaLIbrary.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/storyLibrary.png" /></a>-->
    <!--<a href="#"><img height="51" width="50" src="img/navbut/requestStory.png" /></a>-->
<!--</div>-->


<link type="text/css" rel="stylesheet" href="demo.css">

<script type="text/javascript" src="js/jquery.jplayer.min.js"></script>
<script type="text/javascript">

    console.log("storyNewPreviewPage: init");


    $(document).on('pagebeforeshow', '#storyNewPreviewPage', function()
    {
        console.log("storyNewPreviewPage: pagebeforeshow()");

        console.log("storyNewPreviewPage: pagebeforeshow(); Called with Title: " + sessionStorage.getItem("storyTitle"));
        console.log("storyNewPreviewPage: pagebeforeshow(); Called with Date: " + sessionStorage.getItem("storyDate"));
        console.log("storyNewPreviewPage: pagebeforeshow(); Called with Content: " + sessionStorage.getItem("storyContent"));
        console.log("storyNewPreviewPage: pagebeforeshow(); Called with Categories: " + sessionStorage.getItem("storyCategories"));
        console.log("storyNewPreviewPage: pagebeforeshow(); Called with Audio Url: " + sessionStorage.getItem("storyAudioUrl"));
        console.log("storyNewPreviewPage: pagebeforeshow(); Called with Date Slider Value: " + sessionStorage.getItem("storyDateSlider"));

        // 1. Reset buttons to initialized state
        $('#storyNewPublishUploadBtn').button('enable');
        $('#storyNewCancelBtn').button('enable');
        $('#storyNewPublishPopLink').removeClass('ui-disabled');
        $('#storyNewCancelPopLink').removeClass('ui-disabled');
        $('#storyPreviewNewBackBtn').removeClass('ui-disabled');
        $('#storyPreviewNewEditBtn').removeClass('ui-disabled');

        var audioFileName;
        if (sessionStorage.getItem("storyAudioUrl") == null)
            audioFileName = "no.wav";
        else
            audioFileName = sessionStorage.getItem("storyAudioUrl");
        console.log("storyNewPreviewPage: pagebeforeshow(): audioFileName: " + audioFileName);

        console.log("storyNewPreviewPage: destroy and recreate JPlayer");
        $('#jquery_jplayer_preview').jPlayer( "destroy" );
        $('#jquery_jplayer_preview').jPlayer({
            ready: function (event) {
                console.log("storyNewPreview: in JPlayer ready function")     ;
                $(this).jPlayer("setMedia", {
//                        m4a:"http://www.jplayer.org/audio/m4a/TSP-01-Cro_magnon_man.m4a",
//                        oga:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg"
                    wav: audioFileName
                }).jPlayer("play");
            },
            swfPath: "js",
            //supplied: "m4a, oga",
            supplied: "wav",
            wmode: "window",
            smoothPlayBar: true,
            keyEnabled: true
        });


        $('#storyPreviewTitleTxt').html("");
        $('#storyPreviewTitleTxt').append(sessionStorage.getItem("storyTitle"));
        $('#storyPreviewNewAudioTitleListItem').html("");
        $('#storyPreviewNewAudioTitleListItem').append(sessionStorage.getItem("storyTitle") + " narration");
        //$('#storyPreviewNewAudioTitleList').listview('refresh');


        $('#storyPreviewNewPrivacySwitch').val(sessionStorage.getItem("storyPrivacy")).slider("refresh");
        //$('#storyPreviewNewDateSwitch').val(sessionStorage.getItem("storyDateSlider")).slider("refresh");

        $('#storyPreviewDateTxt').html("");
        var storyDate = sessionStorage.getItem("storyDate");
        var storyDateLen = storyDate.length;

        if (sessionStorage.getItem("storyDateSlider") == 0) { //exact
            if (storyDateLen == 10) {
                //var dateFormatted = new Date(storyDate.substring(0,3), storyDate.substring(5,6), storyDate.substring(8,9));
//            console.log("mm: " + storyDate.substring(5,7));
//            console.log("yy: " + storyDate.substring(0,4));
//            console.log("dd: " +  storyDate.substring(8,10));
                var dateFormatted = printMonth(storyDate.substring(5,7)) + ' ' + storyDate.substring(8,10) + ', ' + storyDate.substring(0,4);
                $('#storyPreviewDateTxt').append(dateFormatted);
            }
        } else
            $('#storyPreviewDateTxt').append(storyDate);

        $('#storyPreviewContent').html("");
        $('#storyPreviewContent').append(sessionStorage.getItem("storyContent"));

        var categoryResultArray = JSON.parse(sessionStorage.getItem("storyCategories"));
        $('.fa').remove();
        $('.txtfa').remove();
        if (categoryResultArray == null)  {
            console.log ("storyPreviewPage: pagebeforeshow(): No Categories to Display: removing categoryBtn");
           $('.categoryBtn').remove();
        }
        else {
            console.log ("storyPreviewPage: pagebeforeshow(): Categories found to Display.  Number: " +  categoryResultArray.length);

            if (document.getElementById('categoryBtn') == null ) {
                console.log("storyPreviewPage: pagebeforeshow(): Re-adding categoryBtn to DOM");
                $('#previewCategoryDiv').append('<a id="categoryBtn" class="categoryBtn" data-theme="none" data-role="none">');
            }
            for(i = 0; i < categoryResultArray.length; i++) {
                //console.log("value at index: " + i + " is " + categoryResultArray[i] )

                var catDescr = sessionStorage.getItem("appCacheCat" + categoryResultArray[i]);
                var catItem = '<i class="fa fa-tag fa-3x" style="color:white;padding:5px;" data-theme="none" data-role="none"></li><div class="txtfa"> ' + catDescr + '</div>' ;

                console.log("storyPreviewPage: pagebeforeshow(): Category Add: " + catItem);
                $('.categoryBtn').append(catItem);

            }
            $('#previewCategoryDiv').trigger('create');
        }

        console.log ("storyPreviewPage: pagebeforeshow(): Start Media Processing for: " + sessionStorage.getItem("storyMediaItems"));

        var mediaResultArray = JSON.parse(sessionStorage.getItem("storyMediaItems"));

        console.log("storyPreviewPage: pagebeforeshow(): removing only checkboxes for the preview page");
        $('#controlgroupPreview .ui-checkbox').remove();
        if (mediaResultArray != null)
        {
            var group = $( "#controlgroupPreview" );
            //console.log("before inner for statement")

            for(i = 0; i < mediaResultArray.length; i++) {
                var $el;
                var theUrl = sessionStorage.getItem("storyAddMediaId" + mediaResultArray[i]) ;
                //console.log("before if check on url");
                //console.log(theUrl);
                if (theUrl != null) {
                   // console.log("in url not null");
                    $el = $('<input type="checkbox"  data-inline="true" id="mediaCheck' + mediaResultArray[i] + '" class="mediaCheck" value=' + mediaResultArray[i]  +' ><label for="mediaCheck' + mediaResultArray[i]  +'"><img width=200 height=200 src= "' + theUrl+ '"></label>');
                    //console.log("Element :" + $el);
                    $( "#controlgroupPreview" ).controlgroup( "container" )["append"]( $el );
                }
            }
            group.controlgroup( "refresh" );
            $('#controlgroupPreview').trigger('create');

        }
        console.log ("storyPreviewPage: pagebeforeshow(): End Media Processing"   );

        // 4. Set any button event handlers remembering to unset them first
        $(document).off('click', '#storyNewPublishUploadBtn').on('click', '#storyNewPublishUploadBtn',function(event) {

            console.log("storyPreviewPage: storyNewPublishUploadBtn.click()");

            console.log("storyPreviewPage: storyPreviewNewPublishUploadBtn: turning off audio play.")  ;
            $('#jquery_jplayer_preview').jPlayer("stop");

            $('#storyNewPublishUploadBtn').button('disable');
            $('#storyNewCancelBtn').button('disable');
            $('#storyNewPublishPopLink').addClass('ui-disabled');
            $('#storyNewCancelPopLink').addClass('ui-disabled');

            var catArr = new Array();
            catArr = JSON.parse(sessionStorage.getItem("storyCategories"));
            var mediaArr = new Array();
            mediaArr = JSON.parse(sessionStorage.getItem("storyMediaItems"));

            var storyContentClean = sessionStorage.getItem("storyContent");

            //str.replace(/blue/g,"red");
            storyContentClean = storyContentClean.replace(/&nbsp;/g, " ");
            //storyContentClean = encodeURI(storyContentClean);
            console.log("cleaning content: replace g " + storyContentClean);

            var storyAddJson = {
                title: sessionStorage.getItem("storyTitle"),
                descr: null,
                excerpt: null,
                categoryList:  catArr,
                mediaList: mediaArr,
                recordingUrl: null,
                archived: Number(0),
                age: null,
                storyMM: null,
                storyDD: null,
                storyYY: null,
                privacySetting: Number(sessionStorage.getItem("storyPrivacy")),
                publishStatus: Number(0),
                content:storyContentClean
            }
            var storyDate = sessionStorage.getItem("storyDate");
            if (storyDate.length = 10)  {
                storyAddJson.storyMM = storyDate.substring(5,7);
                storyAddJson.storyYY = storyDate.substring(0,4);
                storyAddJson.storyDD = storyDate.substring(8,10);
            }
            if (storyDate.length = 4) {
                storyAddJson.storyYY = storyDate;
            }

            console.log("storyPreviewNewPage: publish: json=" + JSON.stringify(storyAddJson));

            $.ajax({
                //type: "POST",
                type: "GET",
                url: tsServiceURLDomain + "tssvc/resourcesS/stories/add/?storyAddJson=" + JSON.stringify(storyAddJson),
                //url: tsServiceURLDomain + "tssvc/resourcesS/stories/add/",
                //data:'user='+ $('#user').val() +'&pass='+ $('#pass').val(),
                //data: "storyAddJson=" + storyAddJson,
                cache: false,
                success: function(data) {

                    console.log("storyPreviewNewPage: addStory: success data: " + data);
                    console.log("storyPreviewNewPage: addStory: success Story Id: " + data.id);

                    console.log("storyPreviewNewPage: addStory: checking if Audio narration exists.  Follows session value:");
                    console.log(sessionStorage.getItem("storyAudioUrl"));

                    if (sessionStorage.getItem("storyAudioUrl") == null) {
                        removeNewStoryStorage();
                        $('#controlgroup .ui-checkbox').remove(); // get rid of media checkbox items (storyEditNewPage)
                        $.mobile.changePage('tsnav.html');
                        return;
                    }
                    var options = new FileUploadOptions();
                    options.fileKey="file";
                    options.fileName= "audio.wav";
                    options.mimeType="audio/wav";

                    var params = {};
                    params.value1 = "test";
                    params.value2 = "param";
                    options.params = params;
                    var ft = new FileTransfer();
                    // error checking needed here
                    ft.upload(mediaAudioUrl, encodeURI(tsServiceURLDomain + "tssvc/resourcesS/stories/audio/" + data.id), function() {
                        //$(jQErrorName).val("in audio upload success");
                        removeNewStoryStorage();
                        $('#controlgroup .ui-checkbox').remove(); // get rid of media checkbox items (storyEditNewPage)
                        $.mobile.changePage('tsnav.html');
                        return;
                    }, function() {
                        alert("in audio upload fail");
                    }, options);

                },
                error: function() { // server couldn't be reached or other error
                    alert("Story add failed");
                }
            })      ;

//            var fileUrl = sessionStorage.getItem("fileUrl");
//            var mediaId;
//            if (Number(fileUrl.indexOf("http")) > 0)  {
//                console.log("url contains http: " + fileUrl);
//                uploadFileFromUrl();
//                console.log("id returned: " + mediaId)
//            }
//            else   {
//                console.log("url does not contain http: " + fileUrl);
//                uploadFileFromFileHandle () ;
//            }
        });

        $(document).off('click', '#storyNewCancelBtn').on('click', '#storyNewCancelBtn',function(event) {

            console.log("storyPreviewPage: storyNewCancelBtn.click()");
            console.log("storyPreviewPage: storyNewCancelBtn: turning off audio play.")  ;
            $('#jquery_jplayer_preview').jPlayer("stop");

            $('#storyNewCancelBtn').button('disable');
            $('#storyNewPublishUploadBtn').button('disable');
            $('#storyNewPublishPopLink').addClass('ui-disabled');
            $('#storyNewCancelPopLink').addClass('ui-disabled');

            removeNewStoryStorage();
            $('#controlgroup .ui-checkbox').remove(); // get rid of media checkbox items (storyEditNewPage)

            $.mobile.changePage('tsnav.html');

        });

        $(document).off('click', '#storyPreviewNewBackBtn').on('click', '#storyPreviewNewBackBtn',function(event) {

            console.log("storyPreviewPage: storyPreviewNewBackBtn.click()");
            console.log("storyPreviewPage: storyPreviewNewBackBtn: turning off audio play.")  ;
            $('#jquery_jplayer_preview').jPlayer("stop");

            $.mobile.changePage('storyNarrate.html');

        });

        $(document).off('click', '#storyPreviewNewEditBtn').on('click', '#storyPreviewNewEditBtn',function(event) {

            console.log("storyPreviewPage: storyPreviewNewEditBtn.click()");
            console.log("storyPreviewPage: storyPreviewNewEditBtn: turning off audio play.")  ;
            $('#jquery_jplayer_preview').jPlayer("stop");

            $.mobile.changePage('storyNarrate.html');

        });


        console.log("storyPreviewPage: pagebeforeshow(): end");

    });

    function printMonth(mm) {
        var month=new Array(12);

        month[0]="January";
        month[1]="February";
        month[2]="March";
        month[3]="April";
        month[4]="May";
        month[5]="June";
        month[6]="July";
        month[7]="August";
        month[8]="September";
        month[9]="October";
        month[10]="November";
        month[11]="December";

        return(month[Number(mm)-1]);
    }


</script>

</div> <!-- end of storyPreviewPage -->

</body>
</html>